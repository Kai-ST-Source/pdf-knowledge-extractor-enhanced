#!/bin/bash

# Get the directory where this app is located
APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
# Change to the actual source directory where src/app.py is located
SOURCE_DIR="/Users/hideki/pdf_knowledge_extractor_mac"

# Change to source directory
cd "$SOURCE_DIR"

# Function to show GUI selection when no files provided
show_gui() {
    # Try Python GUI first
    if command -v python3 >/dev/null 2>&1; then
        python3 -c "
import tkinter as tk
from tkinter import filedialog, messagebox
import subprocess
import sys
import os

# Hide the root window initially
root = tk.Tk()
root.withdraw()

try:
    # Ask user to select PDF files
    file_paths = filedialog.askopenfilenames(
        title='Select PDF files to process',
        filetypes=[('PDF files', '*.pdf'), ('All files', '*.*')]
    )
    
    if file_paths:
        # Process each selected file
        for file_path in file_paths:
            print(f'Processing: {file_path}')
            try:
                result = subprocess.run([
                    sys.executable, 'src/app.py', file_path
                ], capture_output=True, text=True, cwd='/Users/hideki/pdf_knowledge_extractor_mac')
                
                print(f'Command output: {result.stdout}')
                print(f'Command stderr: {result.stderr}')
                print(f'Return code: {result.returncode}')
                
                if result.returncode != 0:
                    print(f'Error processing {file_path}: {result.stderr}')
                    messagebox.showerror('Processing Error', f'Error processing {os.path.basename(file_path)}:\n{result.stderr}')
                else:
                    print(f'Successfully processed: {file_path}')
                    # Check if files were actually created
                    output_dir = '/Users/hideki/Desktop/PDF knowledge extractor'
                    base_name = os.path.splitext(os.path.basename(file_path))[0]
                    expected_files = [f'{base_name}.md', f'{base_name}.json', f'{base_name}.txt', f'{base_name}.xlsx']
                    
                    created_files = []
                    for expected_file in expected_files:
                        file_path_check = os.path.join(output_dir, expected_file)
                        if os.path.exists(file_path_check):
                            created_files.append(expected_file)
                    
                    if created_files:
                        print(f'Created files: {created_files}')
                    else:
                        print('Warning: No output files found!')
                        messagebox.showwarning('Warning', f'Processing completed but no output files found for {os.path.basename(file_path)}')
            except Exception as e:
                print(f'Exception processing {file_path}: {e}')
        
        # Show completion message
        messagebox.showinfo('PDF Knowledge Extractor', 
                          f'Processing completed for {len(file_paths)} file(s).\n\nResults saved to ~/Desktop/PDF knowledge extractor/')
    else:
        print('No files selected')
        
except Exception as e:
    print(f'GUI error: {e}')
    # Fallback to command line
    messagebox.showerror('Error', f'GUI error: {e}\nPlease use command line interface.')

root.destroy()
"
    else
        echo "Python3 not available for GUI"
        return 1
    fi
}

# Check if files were passed as arguments
if [ $# -gt 0 ]; then
    echo "Processing dropped files..."
    for file in "$@"; do
        if [[ "$file" == *.pdf ]]; then
            echo "Processing: $file"
            python3 src/app.py "$file"
        else
            echo "Skipping non-PDF file: $file"
        fi
    done
    
    # Show notification
    osascript -e "display notification \"Processing completed\" with title \"PDF Knowledge Extractor\""
else
    echo "No files provided, showing file selection dialog..."
    show_gui
fi
